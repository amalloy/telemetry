<!DOCTYPE html>
<title>Telemetry Admin</title>

<head>
  <link rel="stylesheet" type="text/css" href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css">
  <link rel="stylesheet" type="text/css" href="/teleturn/lib/nv.d3.css">
  <link rel="stylesheet" type="text/css" href="/teleturn/teleturn.css">
  <link rel="stylesheet" type="text/css" href="/telemetry/style.css">

  <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/2.10.0/d3.v2.js"></script>

  <script src="/teleturn/lib/nv.d3.js"></script>
  <script src="/teleturn/teleturn.js"></script>

  <script>
    window.Teleturn = new Teleturn({
      server:  "telemetry-001.geni.com:1847",
      runPath: "inspect"
    });

    Teleturn.clickQuery = function(d) {
      $("#name").val(d.opts.name);
      $("#query").val(d.opts.query);
      $("#target").val(d.opts.target);
      if (d.opts.target) showAdvanced();
    };

    Teleturn.testQuery = function(opts) {
      startQuery(opts.query);
    };

    Teleturn.addTree("#query-tree");

    function selectTree(type) {
      $("#type").val(type);
      window.location.hash = "#" + type;
      Teleturn.selectTree(type);
    };

    function hideAdvanced() {
      $("#advanced").attr("data-visible", "");
      $("#advanced").html("advanced &raquo;");
      $("#advanced-container").hide();
    };

    function showAdvanced() {
      $("#advanced").attr("data-visible", true);
      $("#advanced").html("advanced &laquo;");
      $("#advanced-container").css({display:"inline"});
    };

    function toggleAdvanced() {
      if ($("#advanced").attr("data-visible")) {
        hideAdvanced();
      } else {
        showAdvanced();
      }
      return false;
    };

    var testXhr;
    function startQuery(query) {
      if (query) {
        var count = 0;
        $("#test").html("Stop")
        $("#inspect-query").html(query)
        $("#inspect-progress").removeAttr("value").css({opacity: 1});
        $("#inspect-results").val("");
        testXhr = Teleturn.runQuery({query: query}, function(d) {
          count = (count + 1) % 100;
          $("#inspect-progress").attr({value: count});
          $("#inspect-results").val(d).scrollTop(999999999);
        });
      }
    };

    function stopQuery() {
      testXhr.abort();
      testXhr = null;
      $("#test").html("Test");
      $("#inspect-progress").css({opacity: 0.3})
      setTimeout(function() {
        $("#inspect-progress").attr({value: 0});
      }, 100);
    };

    function toggleQuery() {
      if (testXhr) {
        stopQuery();
      } else {
        startQuery($("#query").val() || $("#inspect-query").text());
      }
    };

    $(window).on("hashchange", function() {
      selectTree(window.location.hash.substr(1));
    });

    $(document).ready(function() {
      $("#type").change(function(e) {
        selectTree($(this).val());
      });

      Teleturn.addOpts("type", "#type");
      selectTree(window.location.hash.substr(1) || "phonograph");

      $("#add").click(function(e) {
        var $button = $(this);
        $button.attr("disabled", true);
        Teleturn.addQuery({
          name:        $("#name").val(),
          target:      $("#target").val(),
          type:        $("#type").val(),
          query:       $("#query").val(),
          replaySince: $("#replay-since").val()
        }, function(d) {
          $button.attr("disabled", false);
        });
      });

      $("#test").click(toggleQuery);
      $("#advanced").click(toggleAdvanced);

      $("#name").focus(function(e) { $(this).attr("placeholder", "query:name") });
      $("#name").blur(function(e)  { $(this).attr("placeholder", "name")       });

      $("#target").focus(function(e) { $(this).attr("placeholder", $("#name").val() || "target:name") });
      $("#target").blur(function(e)  { $(this).attr("placeholder", "target")                          });

      $("#replay-since").focus(function(e) { $(this).attr("placeholder", "yyyy-mm-dd")   });
      $("#replay-since").blur(function(e)  { $(this).attr("placeholder", "replay since") });
    });
  </script>
</head>

<body>
  <div id="add-container">
    <form>
      <select id="type"></select>
      <input type="text" id="name" placeholder="name"></input>
      <textarea id="query"></textarea>
      <a href="#" id="advanced">advanced &raquo;</a>
      <span id="advanced-container" style="display:none">
        <input type="date" id="replay-since" placeholder="replay since">
        <input type="text" id="target" placeholder="target"></input>
      </span>
      <div id="buttons">
        <span id="test" class="btn">Test</span>
        <span id="add" class="btn">Add</span>
      </div>
    </form>
  </div>
  <div id="inspect-container">
    <span id="inspect-query" class="ellipsis inspect-header"></span>
    <progress id="inspect-progress" value="" max="100" style="opacity:0.3"></progress>
    <textarea id="inspect-results" disabled="disabled"></textarea>
  </div>
  <div id="query-tree">
  </div>
</body>
